<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Google Sheets + Identity Services</title>

    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <!-- GAPI -->
    <script src="https://apis.google.com/js/api.js"></script>

    <script>
        const CLIENT_ID = "1076564775870-mk83opo3aoj75oa0k8q2ianhbvorct5g.apps.googleusercontent.com";
        const SCOPES = "https://www.googleapis.com/auth/spreadsheets.readonly";
        const SPREADSHEET_ID = "1IBZCayCU8YA98ZhsfY0ZkJX5dGoCbRIx2R3RKKvnzGc";

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        // Chargé quand gapi est prêt
        function gapiLoaded() {
            gapi.load('client', async () => {
                // On initialise le client GAPI avec le doc de découverte pour Sheets
                await gapi.client.init({
                    discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"]
                });
                gapiInited = true;
                maybeEnableButtons();
            });
        }

        // Chargé quand la librairie Google Identity Services est prête
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (tokenResponse) => {
                    if (tokenResponse.access_token) {
                        // Associer le token récupéré à gapi
                        gapi.client.setToken(tokenResponse);
                        // On peut maintenant appeler l'API Sheets
                        listValues();
                    }
                },
            });
            gisInited = true;
            maybeEnableButtons();
        }

        // Active le bouton seulement quand gapi + GIS sont prêts
        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                document.getElementById("authorize_button").style.visibility = "visible";
            }
        }

        // Appelé quand on clique sur "Autoriser"
        function handleAuthClick() {
            tokenClient.requestAccessToken({ prompt: "consent" });
        }

        // Récupère et affiche les données de la Google Sheet
        async function listValues() {
            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: "template!A1:D10",
                });
                const values = response.result.values;
                if (values && values.length > 0) {
                    let output = "<table border='1'>";
                    values.forEach(row => {
                        output += "<tr>";
                        row.forEach(cell => {
                            output += `<td>${cell}</td>`;
                        });
                        output += "</tr>";
                    });
                    output += "</table>";
                    document.getElementById("content").innerHTML = output;
                } else {
                    document.getElementById("content").innerHTML = "Aucune donnée trouvée.";
                }
            } catch (err) {
                console.error("Error reading sheet:", err);
                document.getElementById("content").innerHTML = "Erreur : " + err.message;
            }
        }

        // Au chargement de la page, on déclenche gapiLoaded() et gisLoaded()
        window.onload = () => {
            gapiLoaded();
            gisLoaded();
        };
    </script>
</head>
<body>
<h1>Google Sheets + Identity Services</h1>
<button id="authorize_button" style="visibility: hidden;" onclick="handleAuthClick()">
    Autoriser l'accès à ma feuille
</button>
<div id="content"></div>
</body>
</html>
